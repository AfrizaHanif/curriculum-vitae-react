name: Build & Deploy to Hostinger

on:
  push:
    branches: [main, master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9.0" # Next.js requires Node >= 20.9.0
          cache: "npm"

      - name: Cache dependencies and Next.js build cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .next/cache
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy via lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp
          # Mirror out/ to the server directory. 
          # --delete removes files on server that are not in out/ (clean sync)
          # --parallel uploads multiple files at once for speed
          # set ssl:verify-certificate no avoids issues with shared hosting SSL certs
          lftp -e "set ssl:verify-certificate no; open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}; mirror -R --verbose --delete --parallel=5 out/ /domains/afrizahanif.com/public_html/; quit"
