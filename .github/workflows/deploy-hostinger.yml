name: Build & Deploy to Hostinger

on:
  push:
    branches: [main, master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9.0" # Next.js requires Node >= 20.9.0
          cache: "npm"

      - name: Install dependencies
        run: npm ci mkdir -p /domains/afrizahanif.com/public_html

      - name: Build
        run: npm run build

      - name: (Diagnostic) list remote root and _next (before deploy)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp
          echo "---- remote root listing (before) ----"
          # Attempt to list remote root; disable cert verification to avoid FTPS CN mismatch in CI
          lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_HOST }} -e "set ssl:verify-certificate no; set ssl:check-hostname no; cls -la / || cls -la || echo 'root not found or no access'; quit"
          echo "---- remote _next listing (before) ----"
          # Attempt to list remote _next; don't fail the job if it errors
          lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_HOST }} -e "set ssl:verify-certificate no; set ssl:check-hostname no; cls -la public_html/_next || echo '_next not found or no access'; quit"
        continue-on-error: true

      - name: Deploy via lftp mirror to Hostinger
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp
          echo "Starting lftp mirror upload..."
          # Mirror upload: reverse (local -> remote), delete remote files not present locally, exclude _next
          lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_HOST }} -e "set ssl:verify-certificate no; set ssl:check-hostname no; mirror -R --verbose --parallel=2 --delete -x '^_next($|/)' out /domains/afrizahanif.com/public_html; quit"
          echo "lftp mirror finished."

      - name: (Diagnostic) list remote public_html and _next (after deploy)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp
          echo "---- remote public_html listing (after) ----"
          lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_HOST }} -e "set ssl:verify-certificate no; set ssl:check-hostname no; cls -la /domains/afrizahanif.com/public_html || echo 'public_html not found or no access'; quit"
          echo "---- remote _next listing (after) ----"
          lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_HOST }} -e "set ssl:verify-certificate no; set ssl:check-hostname no; cls -la /domains/afrizahanif.com/public_html/_next || echo '_next not found or no access'; quit"
        continue-on-error: true
