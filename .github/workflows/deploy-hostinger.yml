name: Build & Deploy to Hostinger

on:
  push:
    branches: [main, master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.9.0" # Next.js requires Node >= 20.9.0
          cache: "npm"

      - name: Cache dependencies and Next.js build cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .next/cache
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Enable Maintenance Mode
        env:
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y lftp
          echo "-- uploading maintenance.html"
          lftp -u "$FTP_USERNAME,$FTP_PASSWORD" "$FTP_HOST" -e "set ssl:verify-certificate no; put public/maintenance.html -o /domains/afrizahanif.com/public_html/maintenance.html; quit"
          echo "-- uploading .htaccess (maintenance)"
          lftp -u "$FTP_USERNAME,$FTP_PASSWORD" "$FTP_HOST" -e "set ssl:verify-certificate no; put public/.htaccess.maintenance -o /domains/afrizahanif.com/public_html/.htaccess; quit"
          echo "✓ Maintenance mode enabled"

      - name: Build
        run: npm run build

      - name: Deploy via lftp
        env:
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp
          # Mirror out/ to the server directory. 
          # --delete removes files on server that are not in out/ (clean sync)
          # --parallel uploads multiple files at once for speed
          # --exclude protects maintenance files from deletion during sync
          # set ssl:verify-certificate no avoids issues with shared hosting SSL certs
          lftp -u "$FTP_USERNAME,$FTP_PASSWORD" "$FTP_HOST" -e "set ssl:verify-certificate no; mirror -R --verbose --delete --parallel=5 --exclude=.htaccess* --exclude=maintenance.html out/ /domains/afrizahanif.com/public_html/; quit"
          echo "✓ Deployment completed"

      - name: Disable Maintenance Mode
        if: success()
        env:
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y lftp
          echo "-- removing maintenance.html from server"
          lftp -u "$FTP_USERNAME,$FTP_PASSWORD" "$FTP_HOST" -e "set ssl:verify-certificate no; rm -f /domains/afrizahanif.com/public_html/maintenance.html; quit" || true
          echo "-- restoring original .htaccess"
          lftp -u "$FTP_USERNAME,$FTP_PASSWORD" "$FTP_HOST" -e "set ssl:verify-certificate no; put public/.htaccess -o /domains/afrizahanif.com/public_html/.htaccess; quit"
          echo "✓ Maintenance mode disabled - Site is live"
